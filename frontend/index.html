<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>EVCharging - Centro de Control</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; padding: 20px; }
        h1 { text-align: center; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; gap: 20px; grid-template-columns: 2fr 1.5fr; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Tabla */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background-color: #007bff; color: white; padding: 10px; text-align: left;}
        td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8em; }
        .bg-ACTIVADO { background-color: #28a745; }
        .bg-SUMINISTRANDO { background-color: #007bff; }
        .bg-AVERIADO { background-color: #dc3545; }
        .bg-FUERA_DE_SERVICIO { background-color: #fd7e14; }
        .bg-DESCONECTADO { background-color: #6c757d; }
        .bg-RESERVADO { background-color: #159894; }
        
        /* Info Clima */
        .temp-badge { font-size: 0.85em; color: #333; background: #e2e6ea; padding: 2px 6px; border-radius: 10px; margin-left: 5px;}
        
        /* Botones Acci√≥n */
        .btn-revoke { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .btn-revoke:hover { background-color: #c82333; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }
        /* Botones de Control Operativo */
        .btn-control { border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; margin-right: 3px; }
        .btn-stop { background-color: #ffc107; color: #333; } /* Amarillo/Naranja */
        .btn-stop:hover { background-color: #e0a800; }
        
        .btn-resume { background-color: #17a2b8; } /* Cyan */
        .btn-resume:hover { background-color: #138496; }

        /* Botones Globales (M√°s grandes) */
        .global-controls { display: flex; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeeba; align-items: center;}
        .btn-global { padding: 8px 15px; font-size: 0.9em; text-transform: uppercase; }

        /* Logs */
        #log-console { 
            background: #1e1e1e; color: #eee; height: 500px; overflow-y: auto; 
            padding: 10px; font-family: 'Consolas', monospace; font-size: 0.85em; border-radius: 4px;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .src-CENTRAL { color: #00ff00; }
        .src-REGISTRY { color: #ff00ff; }
        .src-EV_W { color: #00d0ff; }
        .src-MONITOR { color: #ffff00; }
        .src-ENGINE { color: #1455eb; }

        /* Filtros */
        .filter-bar { margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;}
        .filter-btn { padding: 5px; cursor: pointer; border: 1px solid #ddd; border-radius: 3px; }
        .filter-btn.active { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <h1> EVCharging - Panel de Control</h1>

    <div class="container">
        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="card">
                <h2> Estado de Puntos de Recarga (CPs)</h2>

                <div class="global-controls">
                    <span style="font-weight:bold; color:#856404;"> CONTROL DE EMERGENCIA:</span>
                    <button class="btn-control btn-stop btn-global" onclick="comandoGlobal('PARAR')">‚è∏ PARAR TODOS</button>
                    <button class="btn-control btn-resume btn-global" onclick="comandoGlobal('REANUDAR')">‚ñ∂ REANUDAR TODOS</button>
                </div>

                <table id="tabla-cps">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ubicaci√≥n / Clima</th>
                            <th>Estado</th>
                            <th>Info Suministro</th>
                            <th>Acciones de Seguridad</th> </tr>
                    </thead>
                    <tbody><tr><td colspan="5">Esperando datos...</td></tr></tbody>
                </table>
            </div>
            
            <div class="card">
                <h2> Configuraci√≥n Clim√°tica (EV_W)</h2>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label>Umbral de Temperatura (Alerta Fr√≠o):</label>
                    <input type="number" id="tempInput" value="0" style="width:60px; padding:5px;"> <span>¬∫C</span>
                    <button onclick="cambiarUmbral()" style="background:#28a745; color:white; border:none; padding:6px 12px; cursor:pointer; border-radius:4px;">Actualizar Umbral</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2> Eventos en Tiempo Real</h2>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="setFilter('ALL')">TODOS</button>
                <button class="filter-btn" onclick="setFilter('REGISTRY')">REGISTRY</button>
                <button class="filter-btn" onclick="setFilter('CENTRAL')">CENTRAL</button>
                <button class="filter-btn" onclick="setFilter('EV_W')">CLIMA</button>
                <button class="filter-btn" onclick="setFilter('MONITOR')">MONITOR</button>
                <button class="filter-btn" onclick="setFilter('ENGINE')">ENGINE</button>
            </div>
            <div id="log-console">Conectando con API Central...</div>
        </div>
    </div>

    <script>
        const API = 'http://127.0.0.1:5000/api';
        let currentFilter = 'ALL';
        let allLogs = [];
        let cityTemps = {}; 

        async function update() {
            try {
                // 1. Obtener Estado
                const res = await fetch(`${API}/estado`);
                const data = await res.json();
                
                cityTemps = data.city_temps || {}; 
                
                // Actualizar placeholder del input si no tiene foco
                if(document.activeElement.id !== 'tempInput') {
                    document.getElementById('tempInput').value = data.config.temp_umbral;
                }

                renderTable(data.cps);

                // 2. Obtener Logs
                const resLog = await fetch(`${API}/logs`);
                const dataLog = await resLog.json();
                allLogs = dataLog.logs;
                renderLogs();

            } catch (e) { 
                console.error("Error conectando con API:", e); 
            }
        }

        // --- ACCIONES ---
        async function comandoCP(cpId, accion) {
            try {
                const res = await fetch(`${API}/comandos/cp`, {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({cp_id: cpId, action: accion})
                });
                const data = await res.json();
                if(res.ok) {
                    // Feedback visual r√°pido
                    alert(`‚úÖ Comando ${accion} enviado a ${cpId}`);
                    update(); 
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch(e) { console.error(e); }
        }

        async function comandoGlobal(accion) {
            if(!confirm(`¬øSeguro que quieres ${accion} TODOS los puntos de carga conectados?`)) return;
            
            try {
                const res = await fetch(`${API}/comandos/todos`, {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({action: accion})
                });
                const data = await res.json();
                alert(data.message);
                update();
            } catch(e) { console.error(e); }
        }

        // --- ACTUALIZACI√ìN DE RENDER TABLE ---
        
        function renderTable(cps) {
            const tbody = document.querySelector('#tabla-cps tbody');
            if(!cps || cps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay CPs registrados.</td></tr>';
                return;
            }

            tbody.innerHTML = cps.map(cp => {
                let tempHtml = "";
                for (const city in cityTemps) {
                    if (cp.location && cp.location.toLowerCase().includes(city.toLowerCase())) {
                        tempHtml = `<span class="temp-badge">üå°Ô∏è ${cityTemps[city]}¬∫C</span>`;
                        break; 
                    }
                }

                // Botones de acci√≥n individuales
                // Solo mostramos Parar/Reanudar si NO est√° revocado (Fuera de servicio por seguridad)
                let actionButtons = "";
                if(cp.status !== 'FUERA_DE_SERVICIO') {
                    actionButtons = `
                        <button class="btn-control btn-stop" onclick="comandoCP('${cp.id}', 'PARAR')" title="Parar CP">‚è∏</button>
                        <button class="btn-control btn-resume" onclick="comandoCP('${cp.id}', 'REANUDAR')" title="Reanudar CP">‚ñ∂</button>
                    `;
                }

                // Bot√≥n Revocar (existente)
                let btnRevoke = `<button class="btn-revoke" onclick="revocarClaves('${cp.id}')" title="Simular ataque">‚ò†Ô∏è</button>`;
                if(cp.status === 'FUERA_DE_SERVICIO') {
                    btnRevoke = `<span style="color:orange; font-size:0.8em;">‚ö† REVOCADO</span>`;
                    // Si est√° revocado, quiz√°s quieras permitir reanudar manualmente si recuper√≥ claves pero se qued√≥ pillado
                    // Ocultamos los controles normales para forzar la recuperaci√≥n autom√°tica, o los dejamos visibles.
                    // En este dise√±o, si est√° revocado, oculto Parar/Reanudar para priorizar la seguridad.
                }

                return `
                <tr>
                    <td><b>${cp.id}</b></td>
                    <td>${cp.location} ${tempHtml}</td>
                    <td><span class="badge bg-${cp.status}">${cp.status}</span></td>
                    <td>${cp.status==='SUMINISTRANDO' ? `‚ö° ${cp.kwh?.toFixed(2)} kWh` : '<span style="color:#ccc;">-</span>'}</td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${actionButtons}
                            <span style="border-left:1px solid #ccc; margin:0 8px; height:20px;"></span>
                            ${btnRevoke}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        
        async function cambiarUmbral() {
            const val = document.getElementById('tempInput').value;
            await fetch(`${API}/config/umbral`, {
                method: 'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({umbral: val})
            });
            alert("Umbral actualizado. EV_W detendr√° CPs si baja de esa temperatura.");
        }

        async function revocarClaves(cpId) {
            if(!confirm(`¬øEST√ÅS SEGURO?\n\nEsto simular√° una brecha de seguridad en ${cpId}.\n\n1. Se borrar√°n sus claves en BD.\n2. La Central rechazar√° su conexi√≥n.\n3. El CP deber√≠a intentar re-autenticarse autom√°ticamente.`)) return;

            try {
                const res = await fetch(`${API}/admin/revoke-key`, {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({cp_id: cpId})
                });
                const data = await res.json();
                if(res.ok) {
                    alert(`‚úÖ ${data.message}`);
                    update(); // Refrescar tabla inmediato
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch(e) {
                alert("Error de conexi√≥n con Central API");
            }
        }

        // --- RENDERIZADO ---

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderLogs();
        }

        function renderLogs() {
            const div = document.getElementById('log-console');
            
            // Filtrado
            const filtered = allLogs.filter(l => {
                if(currentFilter === 'ALL') return true;
                return l.source === currentFilter;
            });
            
            div.innerHTML = filtered.map(l => {
                let msg = (typeof l.msg === 'object') ? JSON.stringify(l.msg) : l.msg;
                let src = l.source;
                
                if(src === 'CENTRAL') {
                    if(msg.includes('[CLIMA]')) src = 'EV_W';
                    if(msg.includes('REGISTRO') || msg.includes('REGISTRY')) src = 'REGISTRY';
                }

                // Generamos la l√≠nea con el color del m√≥dulo original (src-MONITOR, src-ENGINE, etc.)
                return `<div class="log-line">
                            <span style="color:#888; font-size:0.8em;">[${new Date(l.timestamp * 1000).toLocaleTimeString()}]</span>
                            <span class="log-src src-${src}">[${src}]</span> 
                            ${msg}
                        </div>`;
            }).join('');
            
            // Auto-scroll solo si estamos abajo
            // div.scrollTop = div.scrollHeight; 
        }

        function renderTable(cps) {
            const tbody = document.querySelector('#tabla-cps tbody');
            if(!cps || cps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay CPs registrados en la Base de Datos.</td></tr>';
                return;
            }

            tbody.innerHTML = cps.map(cp => {
                // Clima (Tu l√≥gica actual)
                let tempHtml = "";
                for (const city in cityTemps) {
                    if (cp.location && cp.location.toLowerCase().includes(city.toLowerCase())) {
                        tempHtml = `<span class="temp-badge">üå°Ô∏è ${cityTemps[city]}¬∫C</span>`;
                        break; 
                    }
                }

                // NUEVO: L√≥gica del bot√≥n de Revocaci√≥n
                // Si el CP est√° "FUERA_DE_SERVICIO", asumimos que ya ha sido revocado o parado,
                // as√≠ que desactivamos el bot√≥n visualmente para que no se pulse dos veces.
                let isRevoked = (cp.status === 'FUERA_DE_SERVICIO' || cp.status === 'DESCONECTADO');
                
                let btnRevoke;
                if (isRevoked) {
                    // Bot√≥n gris desactivado
                    btnRevoke = `<button class="btn-revoke btn-disabled" disabled>REVOCADO</button>`;
                } else {
                    // Bot√≥n rojo activo
                    btnRevoke = `<button class="btn-revoke" onclick="revocarClaves('${cp.id}')">‚ò¢Ô∏è REVOCAR CLAVES</button>`;
                }

                // Informaci√≥n de suministro
                let infoSum = (cp.status === 'SUMINISTRANDO' && cp.kwh) 
                              ? `‚ö° ${cp.kwh.toFixed(2)} kWh` 
                              : '<span style="color:#ccc;">-</span>';

                return `
                <tr>
                    <td><b>${cp.id}</b></td>
                    <td>${cp.location} ${tempHtml}</td>
                    <td><span class="badge bg-${cp.status}">${cp.status}</span></td>
                    <td>${infoSum}</td>
                    <td style="text-align:center;">${btnRevoke}</td>
                </tr>`;
            }).join('');
        }

        setInterval(update, 2000); // Refresco cada 2s
        update();
    </script>
</body>
</html>